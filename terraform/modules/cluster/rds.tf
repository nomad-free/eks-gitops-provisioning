# =============================================================================
# ğŸ—„ï¸ rds.tf - AWS RDS PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
# =============================================================================
#
# ğŸ“š ì´ íŒŒì¼ì˜ ì—­í• :
# - PostgreSQL RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
# - DB ì„œë¸Œë„· ê·¸ë£¹ êµ¬ì„± (Private Subnetì— ë°°ì¹˜)
# - ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • (EKS ë…¸ë“œì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©)
# - Secrets Managerì— DB ì—°ê²° ì •ë³´ ìë™ ì €ì¥
#
# ğŸ” ë³´ì•ˆ ì•„í‚¤í…ì²˜:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                              VPC                                         â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
# â”‚  â”‚                     Private Subnets                              â”‚   â”‚
# â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
# â”‚  â”‚  â”‚  EKS Node   â”‚â”€â”€5432 Portâ”€â”€â†’â”‚    RDS      â”‚                   â”‚   â”‚
# â”‚  â”‚  â”‚  (Pod)      â”‚              â”‚ PostgreSQL  â”‚                   â”‚   â”‚
# â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
# â”‚  â”‚        â”‚                             â”‚                           â”‚   â”‚
# â”‚  â”‚        â”‚                             â”‚                           â”‚   â”‚
# â”‚  â”‚        â–¼                             â–¼                           â”‚   â”‚
# â”‚  â”‚  Security Group              Security Group                      â”‚   â”‚
# â”‚  â”‚  (EKS Node SG)               (RDS SG - 5432 í—ˆìš©)               â”‚   â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
# â”‚                                                                         â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
# â”‚  â”‚                    Public Subnets (ì¸í„°ë„· ì ‘ê·¼ ë¶ˆê°€)             â”‚   â”‚
# â”‚  â”‚                    - RDSëŠ” ì—¬ê¸°ì— ë°°ì¹˜ë˜ì§€ ì•ŠìŒ                  â”‚   â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ”„ ë°ì´í„° íë¦„:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  Terraform   â”‚â”€â”€â”€â†’â”‚  RDS ìƒì„±    â”‚â”€â”€â”€â†’â”‚  ë¹„ë°€ë²ˆí˜¸    â”‚â”€â”€â”€â†’â”‚  Secrets     â”‚
# â”‚  Apply       â”‚    â”‚  (ìë™)      â”‚    â”‚  ìë™ ìƒì„±   â”‚    â”‚  Manager     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                                                    â”‚
#                                                                    â–¼
#                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                                         â”‚  K8s Pod     â”‚â†â”€â”€â”€â”‚  External    â”‚
#                                         â”‚  (ì•±)        â”‚    â”‚  Secrets     â”‚
#                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                        Dev vs Prod ë¹„êµ                                  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  í•­ëª©                   â”‚  Dev                â”‚  Prod                   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  ì¸ìŠ¤í„´ìŠ¤ í´ë˜ìŠ¤        â”‚  db.t4g.micro       â”‚  db.t4g.small           â”‚
# â”‚  ìŠ¤í† ë¦¬ì§€               â”‚  20 GB              â”‚  50 GB                  â”‚
# â”‚  Multi-AZ               â”‚  false (ë¹„ìš© ì ˆê°)  â”‚  true (ê³ ê°€ìš©ì„±)        â”‚
# â”‚  ë°±ì—… ë³´ê´€ ê¸°ê°„         â”‚  7ì¼                â”‚  30ì¼                   â”‚
# â”‚  ì‚­ì œ ë³´í˜¸              â”‚  false              â”‚  true                   â”‚
# â”‚  ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸          â”‚  false              â”‚  true                   â”‚
# â”‚  ì•”í˜¸í™”                 â”‚  true               â”‚  true                   â”‚
# â”‚  ì˜ˆìƒ ì›” ë¹„ìš©           â”‚  ~$15               â”‚  ~$60                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# =============================================================================

# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 1: ë¡œì»¬ ë³€ìˆ˜ ì •ì˜ (í™˜ê²½ë³„ ì„¤ì •)
# =============================================================================
#
# ì™œ localsë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
# - í™˜ê²½ë³„ ì„¤ì •ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬
# - ì½”ë“œ ì¤‘ë³µ ì œê±° ë° ìœ ì§€ë³´ìˆ˜ ìš©ì´
# - var.environmentë¡œ ìë™ ë¶„ê¸°
#
locals {
  # ---------------------------------------------------------------------------
  # RDS ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
  # ---------------------------------------------------------------------------
  rds_config = {
    dev = {
      # db.t4g.micro: 2 vCPU, 1GB RAM
      # - ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì¶©ë¶„
      # - ì›” ~$12 (On-Demand)
      instance_class = "db.t4g.micro"

      # 20GB: ê°œë°œìš© ìµœì†Œ ìŠ¤í† ë¦¬ì§€
      # - gp3ëŠ” ìµœì†Œ 20GBë¶€í„° ì‹œì‘
      allocated_storage     = 20
      max_allocated_storage = 50 # ì˜¤í† ìŠ¤ì¼€ì¼ë§ ìµœëŒ€ê°’

      # Multi-AZ ë¹„í™œì„±í™”
      # - ê°œë°œ í™˜ê²½ì€ ë‹¨ì¼ AZë¡œ ë¹„ìš© ì ˆê°
      # - ì¥ì•  ì‹œ ë³µêµ¬ ì‹œê°„ì´ ê¸¸ì–´ì§€ì§€ë§Œ ê°œë°œì—ëŠ” ë¬¸ì œì—†ìŒ
      multi_az = false

      # ë°±ì—… 7ì¼ ë³´ê´€
      # - ê°œë°œ í™˜ê²½ì€ ìµœì†Œí•œì˜ ë°±ì—…
      backup_retention_period = 7

      # ì‚­ì œ ë³´í˜¸ ë¹„í™œì„±í™”
      # - ê°œë°œ í™˜ê²½ì€ ììœ ë¡­ê²Œ ì‚­ì œ ê°€ëŠ¥
      deletion_protection = false

      # ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ ë¹„í™œì„±í™” (ë¹„ìš© ì ˆê°)
      performance_insights_enabled = false
    }

    prod = {
      # db.t4g.small: 2 vCPU, 2GB RAM
      # - í”„ë¡œë•ì…˜ ìµœì†Œ ê¶Œì¥ ì‚¬ì–‘
      # - ì›” ~$25 (On-Demand, ë‹¨ì¼ AZ ê¸°ì¤€)
      instance_class = "db.t4g.small"

      # 50GB: í”„ë¡œë•ì…˜ ì‹œì‘ ìŠ¤í† ë¦¬ì§€
      # - ë°ì´í„° ì¦ê°€ì— ëŒ€ë¹„í•œ ì—¬ìœ  ê³µê°„
      allocated_storage     = 50
      max_allocated_storage = 200 # ì˜¤í† ìŠ¤ì¼€ì¼ë§ ìµœëŒ€ê°’

      # Multi-AZ í™œì„±í™”
      # - ë‹¤ë¥¸ AZì— Standby ë³µì œë³¸ ìë™ ìƒì„±
      # - Primary ì¥ì•  ì‹œ ìë™ Failover (60-120ì´ˆ)
      # - ë¹„ìš© 2ë°°ì´ì§€ë§Œ ê³ ê°€ìš©ì„± í•„ìˆ˜
      multi_az = true

      # ë°±ì—… 30ì¼ ë³´ê´€
      # - í”„ë¡œë•ì…˜ì€ ì¶©ë¶„í•œ ë°±ì—… ê¸°ê°„ í™•ë³´
      # - Point-in-Time Recovery ê°€ëŠ¥
      backup_retention_period = 30

      # ì‚­ì œ ë³´í˜¸ í™œì„±í™”
      # - ì‹¤ìˆ˜ë¡œ ì¸í•œ ì‚­ì œ ë°©ì§€
      # - ì‚­ì œí•˜ë ¤ë©´ ë¨¼ì € ì´ ì„¤ì •ì„ ë„ê³  ì‚­ì œí•´ì•¼ í•¨
      deletion_protection = true

      # ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ í™œì„±í™”
      # - ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„ ë° ë³‘ëª© ì§€ì  íŒŒì•…
      # - 7ì¼ ë¬´ë£Œ, ê·¸ ì´ìƒì€ ìœ ë£Œ
      performance_insights_enabled = true
    }
  }

  # ---------------------------------------------------------------------------
  # DB ì‹ë³„ì ë° ì´ë¦„
  # ---------------------------------------------------------------------------
  # 
  # ëª…ëª… ê·œì¹™:
  # - db_identifier: AWS ë¦¬ì†ŒìŠ¤ ì‹ë³„ì (í•˜ì´í”ˆ ì‚¬ìš©)
  # - db_name: ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ (ì–¸ë”ìŠ¤ì½”ì–´ ì‚¬ìš©)
  #
  db_identifier = "${local.project_name}-${var.environment}" # exchange-settlement-dev
  db_name       = "exchange_db"                              # PostgreSQL DB ì´ë¦„
  db_username   = "app_admin"                                # ë§ˆìŠ¤í„° ì‚¬ìš©ìëª…
  db_port       = 5432                                       # PostgreSQL ê¸°ë³¸ í¬íŠ¸
}


# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 2: ëœë¤ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
# =============================================================================
#
# ì™œ random_passwordë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
# - í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆ ìœ„í—˜
# - ë§¤ë²ˆ ë‹¤ë¥¸ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ìë™ ìƒì„±
# - Terraform Stateì—ë§Œ ì €ì¥ë˜ê³  ì½”ë“œì—ëŠ” ë…¸ì¶œë˜ì§€ ì•ŠìŒ
#
# âš ï¸ ì£¼ì˜ì‚¬í•­:
# - State íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬ í•„ìˆ˜
# - ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ì•± ì¬ë°°í¬ í•„ìš”
#
resource "random_password" "db_password" {
  length = 32 # 32ìë¦¬ ë¹„ë°€ë²ˆí˜¸

  # íŠ¹ìˆ˜ë¬¸ì ì„¤ì •
  # - RDSì—ì„œ ì¼ë¶€ íŠ¹ìˆ˜ë¬¸ìëŠ” ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŒ
  # - @, ", /, \, ' ë“±ì€ ì œì™¸í•˜ëŠ” ê²ƒì´ ì•ˆì „
  special          = true
  override_special = "!#$%&*()-_=+[]{}<>:?"

  # ë¹„ë°€ë²ˆí˜¸ êµ¬ì„± ìš”ì†Œ
  upper   = true # ëŒ€ë¬¸ì í¬í•¨
  lower   = true # ì†Œë¬¸ì í¬í•¨
  numeric = true # ìˆ«ì í¬í•¨
}


# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 3: DB ì„œë¸Œë„· ê·¸ë£¹
# =============================================================================
#
# DB ì„œë¸Œë„· ê·¸ë£¹ì´ë€?
# - RDSê°€ ë°°ì¹˜ë  ìˆ˜ ìˆëŠ” ì„œë¸Œë„· ëª©ë¡
# - ìµœì†Œ 2ê°œ ì´ìƒì˜ AZì— ê±¸ì¹œ ì„œë¸Œë„· í•„ìš” (AWS ìš”êµ¬ì‚¬í•­)
# - Private Subnetì— ë°°ì¹˜í•˜ì—¬ ì¸í„°ë„· ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨
#
# ì™œ Private Subnetì¸ê°€?
# - ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼í•˜ë©´ ì•ˆ ë¨
# - ì˜¤ì§ VPC ë‚´ë¶€ ë¦¬ì†ŒìŠ¤(EKS Pod)ì—ì„œë§Œ ì ‘ê·¼
# - ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€
#
resource "aws_db_subnet_group" "main" {
  name        = "${local.db_identifier}-subnet-group"
  description = "DB subnet group for ${local.db_identifier}"

  # Private Subnet ì‚¬ìš©
  # - module.vpc.private_subnets: VPC ëª¨ë“ˆì—ì„œ ìƒì„±í•œ í”„ë¼ì´ë¹— ì„œë¸Œë„· ID ëª©ë¡
  # - ì˜ˆ: ["subnet-xxx", "subnet-yyy", "subnet-zzz"] (3ê°œ AZ)
  subnet_ids = module.vpc.private_subnets

  tags = merge(local.common_tags, {
    Name = "${local.db_identifier}-subnet-group"
  })
}


# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 4: RDS ë³´ì•ˆ ê·¸ë£¹
# =============================================================================
#
# ë³´ì•ˆ ê·¸ë£¹ ì„¤ê³„ ì›ì¹™:
# 1. ìµœì†Œ ê¶Œí•œ ì›ì¹™ (Least Privilege)
#    - í•„ìš”í•œ í¬íŠ¸ë§Œ ì—´ê¸° (5432)
#    - í•„ìš”í•œ ì†ŒìŠ¤ë§Œ í—ˆìš© (EKS ë…¸ë“œ)
#
# 2. Ingress (ì¸ë°”ìš´ë“œ) ê·œì¹™:
#    - EKS ë…¸ë“œ ë³´ì•ˆ ê·¸ë£¹ì—ì„œ 5432 í¬íŠ¸ í—ˆìš©
#
# 3. Egress (ì•„ì›ƒë°”ìš´ë“œ) ê·œì¹™:
#    - ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ í—ˆìš© (RDSëŠ” ì™¸ë¶€ë¡œ ì—°ê²°í•  ì¼ì´ ê±°ì˜ ì—†ìŒ)
#
resource "aws_security_group" "rds" {
  name        = "${local.db_identifier}-rds-sg"
  description = "Security group for RDS PostgreSQL"
  vpc_id      = module.vpc.vpc_id

  # ---------------------------------------------------------------------------
  # Ingress: EKS ë…¸ë“œì—ì„œ PostgreSQL ì ‘ê·¼ í—ˆìš©
  # ---------------------------------------------------------------------------
  #
  # source: EKS ë…¸ë“œì˜ ë³´ì•ˆ ê·¸ë£¹
  # - module.eks.node_security_group_id: EKS ëª¨ë“ˆì´ ìƒì„±í•œ ë…¸ë“œ SG
  # - ì´ SGê°€ ë¶™ì€ ë¦¬ì†ŒìŠ¤(EKS ë…¸ë“œ)ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
  #
  ingress {
    description     = "PostgreSQL from EKS nodes"
    from_port       = local.db_port # 5432
    to_port         = local.db_port # 5432
    protocol        = "tcp"
    security_groups = [module.eks.node_security_group_id]
  }

  # ---------------------------------------------------------------------------
  # Egress: ëª¨ë“  ì•„ì›ƒë°”ìš´ë“œ í—ˆìš©
  # ---------------------------------------------------------------------------
  #
  # RDSì—ì„œ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì€ ê±°ì˜ ì—†ì§€ë§Œ,
  # AWS ë‚´ë¶€ ì„œë¹„ìŠ¤(CloudWatch, S3 ë°±ì—… ë“±) í†µì‹ ì„ ìœ„í•´ í—ˆìš©
  #
  egress {
    description = "Allow all outbound"
    from_port   = 0
    to_port     = 0
    protocol    = "-1" # ëª¨ë“  í”„ë¡œí† ì½œ
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = merge(local.common_tags, {
    Name = "${local.db_identifier}-rds-sg"
  })
}


# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 5: RDS PostgreSQL ì¸ìŠ¤í„´ìŠ¤
# =============================================================================
#
# RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
# - PostgreSQL 16 (ìµœì‹  LTS ë²„ì „)
# - gp3 ìŠ¤í† ë¦¬ì§€ (ìµœì‹  ì„¸ëŒ€, ë” ì €ë ´í•˜ê³  ë¹ ë¦„)
# - ì•”í˜¸í™” í™œì„±í™” (ë³´ì•ˆ í•„ìˆ˜)
#
resource "aws_db_instance" "main" {
  # ---------------------------------------------------------------------------
  # ê¸°ë³¸ ì‹ë³„ ì •ë³´
  # ---------------------------------------------------------------------------
  identifier = local.db_identifier # exchange-settlement-dev

  # ---------------------------------------------------------------------------
  # ì—”ì§„ ì„¤ì •
  # ---------------------------------------------------------------------------
  #
  # PostgreSQL 16 ì„ íƒ ì´ìœ :
  # - 2023ë…„ 9ì›” ì¶œì‹œ, í˜„ì¬ LTS
  # - ì„±ëŠ¥ í–¥ìƒ (ë³‘ë ¬ ì¿¼ë¦¬, VACUUM ê°œì„ )
  # - ìƒˆë¡œìš´ ê¸°ëŠ¥ (SQL/JSON í‘œì¤€ ì§€ì› ê°•í™”)
  #
  engine         = "postgres"
  engine_version = "16.4" # ìµœì‹  ë§ˆì´ë„ˆ ë²„ì „

  # ---------------------------------------------------------------------------
  # ì¸ìŠ¤í„´ìŠ¤ ì‚¬ì–‘
  # ---------------------------------------------------------------------------
  instance_class = local.rds_config[var.environment].instance_class

  # ---------------------------------------------------------------------------
  # ìŠ¤í† ë¦¬ì§€ ì„¤ì •
  # ---------------------------------------------------------------------------
  #
  # gp3 vs gp2:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ í•­ëª©           â”‚ gp2             â”‚ gp3             â”‚
  # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  # â”‚ ê¸°ë³¸ IOPS      â”‚ ìš©ëŸ‰ì— ë¹„ë¡€     â”‚ 3,000 (ê³ ì •)    â”‚
  # â”‚ ê¸°ë³¸ ì²˜ë¦¬ëŸ‰    â”‚ ìš©ëŸ‰ì— ë¹„ë¡€     â”‚ 125 MB/s (ê³ ì •) â”‚
  # â”‚ ê°€ê²©           â”‚ $0.10/GB        â”‚ $0.08/GB        â”‚
  # â”‚ ê²°ë¡            â”‚ êµ¬ì„¸ëŒ€          â”‚ ë” ì €ë ´í•˜ê³  ë¹ ë¦„â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  #
  storage_type          = "gp3"
  allocated_storage     = local.rds_config[var.environment].allocated_storage
  max_allocated_storage = local.rds_config[var.environment].max_allocated_storage

  # gp3 IOPS/Throughput (ê¸°ë³¸ê°’ ì‚¬ìš©, í•„ìš”ì‹œ ì¦ê°€ ê°€ëŠ¥)
  # iops                  = 3000   # ê¸°ë³¸ê°’
  # storage_throughput    = 125    # ê¸°ë³¸ê°’ (MB/s)

  # ---------------------------------------------------------------------------
  # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
  # ---------------------------------------------------------------------------
  db_name  = local.db_name     # exchange_db
  username = local.db_username # app_admin
  password = random_password.db_password.result
  port     = local.db_port # 5432

  # ---------------------------------------------------------------------------
  # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
  # ---------------------------------------------------------------------------
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]

  # Public Access ë¹„í™œì„±í™” (ì¤‘ìš”!)
  # - trueë¡œ í•˜ë©´ ì¸í„°ë„·ì—ì„œ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•´ì§ (ë³´ì•ˆ ìœ„í—˜)
  # - Private Subnetì— ìˆì–´ë„ Public IPê°€ í• ë‹¹ë˜ë©´ ì ‘ê·¼ ê°€ëŠ¥
  publicly_accessible = false

  # ---------------------------------------------------------------------------
  # ê³ ê°€ìš©ì„± ì„¤ì •
  # ---------------------------------------------------------------------------
  multi_az = local.rds_config[var.environment].multi_az

  # ---------------------------------------------------------------------------
  # ë°±ì—… ì„¤ì •
  # ---------------------------------------------------------------------------
  #
  # ë°±ì—… ìœˆë„ìš°: UTC ê¸°ì¤€ìœ¼ë¡œ íŠ¸ë˜í”½ì´ ì ì€ ì‹œê°„ëŒ€ ì„ íƒ
  # - 04:00-05:00 UTC = 13:00-14:00 KST (í•œêµ­ ì ì‹¬ì‹œê°„)
  #
  backup_retention_period = local.rds_config[var.environment].backup_retention_period
  backup_window           = "04:00-05:00" # UTC (KST 13:00-14:00)

  # ì‚­ì œ ì‹œ ìµœì¢… ìŠ¤ëƒ…ìƒ· ìƒì„± ì—¬ë¶€
  # - Dev: ìŠ¤ëƒ…ìƒ· ìƒì„± ì•ˆ í•¨ (ë¹ ë¥¸ ì‚­ì œ)
  # - Prod: ìŠ¤ëƒ…ìƒ· ìƒì„± (ë°ì´í„° ë³´ì¡´)
  skip_final_snapshot       = var.environment == "dev" ? true : false
  final_snapshot_identifier = var.environment == "prod" ? "${local.db_identifier}-final-snapshot" : null

  # ---------------------------------------------------------------------------
  # ìœ ì§€ë³´ìˆ˜ ì„¤ì •
  # ---------------------------------------------------------------------------
  #
  # ìœ ì§€ë³´ìˆ˜ ìœˆë„ìš°: ë°±ì—… ìœˆë„ìš°ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ì„¤ì •
  # - Sun 05:00-06:00 UTC = Sun 14:00-15:00 KST
  #
  maintenance_window = "Sun:05:00-Sun:06:00" # UTC

  # ë§ˆì´ë„ˆ ë²„ì „ ìë™ ì—…ê·¸ë ˆì´ë“œ
  # - ë³´ì•ˆ íŒ¨ì¹˜ ìë™ ì ìš©
  auto_minor_version_upgrade = true

  # ---------------------------------------------------------------------------
  # ë³´ì•ˆ ì„¤ì •
  # ---------------------------------------------------------------------------

  # ìŠ¤í† ë¦¬ì§€ ì•”í˜¸í™” (í•„ìˆ˜!)
  # - AWS ê´€ë¦¬í˜• í‚¤ ì‚¬ìš© (ë¬´ë£Œ)
  # - ê³ ê° ê´€ë¦¬í˜• KMS í‚¤ë„ ì‚¬ìš© ê°€ëŠ¥ (ìœ ë£Œ)
  storage_encrypted = true
  # kms_key_id      = aws_kms_key.rds.arn  # ì»¤ìŠ¤í…€ í‚¤ ì‚¬ìš© ì‹œ

  # ì‚­ì œ ë³´í˜¸
  deletion_protection = local.rds_config[var.environment].deletion_protection

  # ---------------------------------------------------------------------------
  # ëª¨ë‹ˆí„°ë§ ì„¤ì •
  # ---------------------------------------------------------------------------

  # ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ (ì¿¼ë¦¬ ë¶„ì„)
  performance_insights_enabled          = local.rds_config[var.environment].performance_insights_enabled
  performance_insights_retention_period = local.rds_config[var.environment].performance_insights_enabled ? 7 : null

  # CloudWatch ë¡œê·¸ ë‚´ë³´ë‚´ê¸°
  # - postgresql: ì¼ë°˜ ë¡œê·¸
  # - upgrade: ì—…ê·¸ë ˆì´ë“œ ë¡œê·¸
  enabled_cloudwatch_logs_exports = ["postgresql", "upgrade"]

  # ---------------------------------------------------------------------------
  # íŒŒë¼ë¯¸í„° ê·¸ë£¹ (ê¸°ë³¸ê°’ ì‚¬ìš©)
  # ---------------------------------------------------------------------------
  # 
  # ì»¤ìŠ¤í…€ íŒŒë¼ë¯¸í„° ê·¸ë£¹ì´ í•„ìš”í•˜ë©´ ë³„ë„ ìƒì„±
  # ì˜ˆ: timezone, max_connections, shared_buffers ë“± íŠœë‹
  #
  # parameter_group_name = aws_db_parameter_group.main.name

  # ---------------------------------------------------------------------------
  # íƒœê·¸
  # ---------------------------------------------------------------------------
  tags = merge(local.common_tags, {
    Name = local.db_identifier
  })

  # ---------------------------------------------------------------------------
  # ë¼ì´í”„ì‚¬ì´í´ ì„¤ì •
  # ---------------------------------------------------------------------------
  lifecycle {
    # ë¹„ë°€ë²ˆí˜¸ê°€ ì™¸ë¶€ì—ì„œ ë³€ê²½ë˜ì–´ë„ Terraformì´ ë®ì–´ì“°ì§€ ì•ŠìŒ
    ignore_changes = [password]
  }

  # ---------------------------------------------------------------------------
  # ì˜ì¡´ì„±
  # ---------------------------------------------------------------------------
  depends_on = [aws_db_subnet_group.main, aws_security_group.rds]
}


# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 6: Secrets Managerì— DB ì—°ê²° ì •ë³´ ìë™ ì €ì¥
# =============================================================================
#
# ê¸°ì¡´ app-secrets ì‹œí¬ë¦¿ ì—…ë°ì´íŠ¸
# - Terraformì—ì„œ ìƒì„±í•œ RDS ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì €ì¥
# - ExternalSecret â†’ K8s Secret â†’ Pod í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…
#
# íë¦„:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  RDS ìƒì„±    â”‚â”€â”€â”€â†’â”‚  Secrets     â”‚â”€â”€â”€â†’â”‚  External    â”‚â”€â”€â”€â†’â”‚  K8s Pod     â”‚
# â”‚              â”‚    â”‚  Manager     â”‚    â”‚  Secrets     â”‚    â”‚  (í™˜ê²½ë³€ìˆ˜)  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#         â”‚                  â”‚
#         â”‚                  â”‚
#         â–¼                  â–¼
#   aws_db_instance    aws_secretsmanager_secret_version
#   .main.endpoint     .app (ìë™ ì—…ë°ì´íŠ¸)
#



# =============================================================================
# ğŸ“Œ ì„¹ì…˜ 7: ì¶œë ¥ê°’ (Outputs)
# =============================================================================
#
# ì´ ê°’ë“¤ì€ terraform output ëª…ë ¹ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥
# ë°°í¬ í›„ ê²€ì¦ì´ë‚˜ ë””ë²„ê¹…ì— ìœ ìš©
#



# =============================================================================
# ğŸ“š íŒŒì¼ ì™„ë£Œ ì •ë¦¬
# =============================================================================
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  âœ… íŒŒì¼ ì™„ë£Œ: terraform/rds.tf                                         â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                          â”‚
# â”‚  ğŸ“ íŒŒì¼ ê²½ë¡œ:                                                          â”‚
# â”‚  terraform/rds.tf                                                        â”‚
# â”‚                                                                          â”‚
# â”‚  ğŸ¯ ì´ íŒŒì¼ì´ í•˜ëŠ” ì¼:                                                  â”‚
# â”‚  "PostgreSQL RDS ìƒì„± + Secrets Manager ìë™ ì—°ë™"                      â”‚
# â”‚                                                                          â”‚
# â”‚  ğŸ“Š ìƒì„±ë˜ëŠ” ë¦¬ì†ŒìŠ¤:                                                    â”‚
# â”‚  â€¢ aws_db_subnet_group.main          - DB ì„œë¸Œë„· ê·¸ë£¹                   â”‚
# â”‚  â€¢ aws_security_group.rds            - RDS ë³´ì•ˆ ê·¸ë£¹                    â”‚
# â”‚  â€¢ aws_db_instance.main              - RDS PostgreSQL ì¸ìŠ¤í„´ìŠ¤          â”‚
# â”‚  â€¢ random_password.db_password       - DB ë¹„ë°€ë²ˆí˜¸ (ìë™ ìƒì„±)          â”‚
# â”‚  â€¢ aws_secretsmanager_secret_version - Secrets Manager ì—…ë°ì´íŠ¸         â”‚
# â”‚                                                                          â”‚
# â”‚  ğŸ”— ì—°ë™ ë°©ì‹:                                                          â”‚
# â”‚  RDS ìƒì„± â†’ ë¹„ë°€ë²ˆí˜¸ ìë™ ìƒì„± â†’ Secrets Manager ìë™ ì €ì¥              â”‚
# â”‚  â†’ External Secrets ë™ê¸°í™” â†’ K8s Secret ìƒì„± â†’ Pod í™˜ê²½ë³€ìˆ˜ ì£¼ì…        â”‚
# â”‚                                                                          â”‚
# â”‚  ğŸ’° ì˜ˆìƒ ë¹„ìš© (ì›”):                                                     â”‚
# â”‚  â€¢ Dev: ~$15 (db.t4g.micro, 20GB, ë‹¨ì¼ AZ)                             â”‚
# â”‚  â€¢ Prod: ~$60 (db.t4g.small, 50GB, Multi-AZ)                           â”‚
# â”‚                                                                          â”‚
# â”‚  âš ï¸ ìˆ˜ë™ ì‘ì—… í•„ìš”:                                                     â”‚
# â”‚  Secrets Managerì—ì„œ ë‹¤ìŒ ê°’ë“¤ì„ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½:                      â”‚
# â”‚  â€¢ API_KEY, API_SECRET                                                  â”‚
# â”‚  â€¢ JWT_SECRET (ìµœì†Œ 32ì)                                               â”‚
# â”‚  â€¢ ENCRYPTION_KEY (ì •í™•íˆ 32ì)                                         â”‚
# â”‚                                                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# =============================================================================
