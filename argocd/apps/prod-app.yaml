# ============================================
# ğŸ†• ì‹ ê·œ - argocd/apps/prod-app.yaml
# ============================================
# ProdëŠ” Devì™€ ë‹¤ë¥¸ ì :
# 1. targetRevision: main (main ë¸Œëœì¹˜)
# 2. automated sync ë¹„í™œì„±í™” (ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
#
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: exchange-settlement-prod
  namespace: argocd
  labels:
    environment: prod
    app.kubernetes.io/part-of: exchange-settlement
  annotations:
    argocd.argoproj.io/sync-wave: "3" # ğŸ†• ESO + NGINX ì´í›„ì— ë°°í¬
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    repoURL: https://github.com/nomad-free/eks-gitops-provisioning.git
    targetRevision: main # ğŸ”‘ main ë¸Œëœì¹˜ ê°ì‹œ
    path: kustomize/overlays/prod

  destination:
    server: https://kubernetes.default.svc
    namespace: app-prod

  syncPolicy:
    # âš ï¸ ProdëŠ” ìë™ Sync ë¹„í™œì„±í™”!
    # ArgoCD UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ "Sync" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°°í¬ë¨
    # ë˜ëŠ” GitHub Actionsì—ì„œ argocd app sync ëª…ë ¹ìœ¼ë¡œ íŠ¸ë¦¬ê±°
    automated: null
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 5m
