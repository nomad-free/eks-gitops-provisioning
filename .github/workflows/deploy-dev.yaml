# ============================================
# âœ… ë³€ê²½ í›„ - .github/workflows/deploy-dev.yaml
# ============================================
# ë³€ê²½ ì‚¬í•­:
# 1. kubectl ê´€ë ¨ ì½”ë“œ ì „ì²´ ì‚­ì œ (configure, apply, rollout, rollback)
# 2. ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ â†’ Git ì»¤ë°‹ìœ¼ë¡œ ë³€ê²½
# 3. ArgoCDê°€ Git ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ìë™ ë°°í¬
# 4. Health check, Rollbackì€ ArgoCDê°€ ìë™ ì²˜ë¦¬
#
name: Deploy to Dev

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write # ğŸ”„ read â†’ write (Git push í•„ìš”)
  packages: write

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  ENVIRONMENT: dev

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy (Dev)
    runs-on: ubuntu-latest
    environment: dev
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Push ê¶Œí•œ í•„ìš”

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-dev-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ†• ArgoCD ë°©ì‹: ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ â†’ Git Commit
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ì´ì „: kubectl apply -k . (Push ë°©ì‹)
      # í˜„ì¬: kustomize íŒŒì¼ ìˆ˜ì • â†’ git push (Pull ë°©ì‹)
      # ArgoCDê°€ develop ë¸Œëœì¹˜ ë³€ê²½ì„ ê°ì§€ â†’ ìë™ Sync
      #
      - name: ğŸ”„ Update image tag in Kustomize
        run: |
          cd kustomize/overlays/dev

          # kustomize CLIë¡œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          kustomize edit set image \
            app=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}

      - name: ğŸ“¤ Commit and push image tag update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add kustomize/overlays/dev/kustomization.yaml

          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(dev): update image to dev-${{ github.sha }} [skip ci]"
            git push
          fi

          # [skip ci]: ì´ ì»¤ë°‹ì´ CIë¥¼ ë‹¤ì‹œ íŠ¸ë¦¬ê±°í•˜ì§€ ì•Šë„ë¡ ë°©ì§€
          # ArgoCDê°€ ì´ ë³€ê²½ì„ ê°ì§€ â†’ ìë™ ë°°í¬

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âŒ ì‚­ì œëœ ë‹¨ê³„ë“¤:
      # - kubectl ì„¤ì • (ArgoCDê°€ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
      # - kubectl apply (ArgoCDê°€ Git Sync)
      # - rollout status (ArgoCD Health Check)
      # - health check (ArgoCD Sync Health)
      # - rollback (ArgoCD ìë™ ë¡¤ë°±)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ğŸ“¢ Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Dev Deploy: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Image Updated* :${{ job.status == 'success' && 'white_check_mark' || 'x' }}:\nImage: `dev-${{ github.sha }}`\nArgoCD will auto-sync shortly."
                  }
                }
              ]
            }
