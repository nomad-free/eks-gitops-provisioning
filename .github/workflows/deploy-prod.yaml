# ============================================
# âœ… ë³€ê²½ í›„ - .github/workflows/deploy-prod.yaml
# ============================================
name: Deploy to Prod

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write # ğŸ”„ read â†’ write (Git push í•„ìš”)
  packages: write

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  ENVIRONMENT: prod

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy (Prod)
    runs-on: ubuntu-latest
    environment: prod # GitHub Environment protection rules ì ìš©
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-prod-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ“ Extract version metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=prod-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-prod
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ğŸ†• ArgoCD ë°©ì‹: ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ â†’ Git Commit
      - name: ğŸ”„ Update image tag in Kustomize
        run: |
          cd kustomize/overlays/prod
          kustomize edit set image \
            app=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}

      - name: ğŸ“¤ Commit and push image tag update
        run: |
          git add kustomize/overlays/prod/kustomization.yaml
          if git diff --staged --quiet; then      # âœ… ì•ˆì „í•œ íŒ¨í„´
            echo "No changes to commit"
          else
            git commit -m "chore(prod): update image to ..."
            git push
          fi

      # âŒ ì‚­ì œëœ ë‹¨ê³„ë“¤:
      # - kubectl ì„¤ì • (ArgoCDê°€ ì²˜ë¦¬)
      # - kubectl apply (ArgoCDê°€ Git Sync)
      # - rollout status (ArgoCD Health Check)
      # - health check (ArgoCDê°€ ì²˜ë¦¬)
      # - rollback (ArgoCD ìë™ ë¡¤ë°±)

      - name: ğŸ“¢ Notify Slack - Ready for Deploy
        if: always()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Prod Deploy: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ job.status == 'success' && 'ğŸ“¦' || 'âŒ' }} *Prod Image ${{ job.status == 'success' && 'Updated' || 'Failed' }}*\nVersion: `${{ steps.meta.outputs.version }}`\n${{ job.status == 'success' && 'âš ï¸ *ArgoCDì—ì„œ ìˆ˜ë™ Sync í•„ìš”*\n`argocd app sync exchange-settlement-prod`' || '' }}"
                  }
                }
              ]
            }
