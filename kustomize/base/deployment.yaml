# =============================================================================
# Deployment - ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒë“œ(Pod)ë¥¼ ê´€ë¦¬í•˜ê³  ë°°í¬í•˜ëŠ” í•µì‹¬ ë¦¬ì†ŒìŠ¤
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app
  labels:
    app.kubernetes.io/name: app
    app.kubernetes.io/component: backend
spec:
  replicas: 1
  revisionHistoryLimit: 5 # ë¡¤ë°±ì„ ìœ„í•´ ìµœê·¼ 5ê°œ ë²„ì „ ìœ ì§€

  # ë¬´ì¤‘ë‹¨ ë°°í¬ ì „ëµ (Rolling Update)
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0 # ë°°í¬ ì¤‘ì—ë„ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ
      maxSurge: 1 # ë°°í¬ ì¤‘ì— íŒŒë“œ 1ê°œë¥¼ ë” ë„ì›€

  selector:
    matchLabels:
      app.kubernetes.io/name: app

  template:
    metadata:
      labels:
        app.kubernetes.io/name: app
        app.kubernetes.io/component: backend

    spec:
      serviceAccountName: app-sa
      automountServiceAccountToken: false

      # Pod Security Standards 'Restricted' ì¤€ìˆ˜
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        # ë‚´ê°€ ì¼ì¼ì´ ê¸ˆì§€ ëª©ë¡ì„ ë§Œë“¤ê¸° ê·€ì°®ìœ¼ë‹ˆ, **ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„(Docker, containerd ë“±)ì´ ë¯¸ë¦¬ ì •ì˜í•´ ë‘” 'í‘œì¤€ ë³´ì•ˆ í”„ë¡œí•„'**ì„ ì“°ê² ë‹¤"ëŠ” ëœ»
        # ì´ ì„¤ì •ì„ ì¼œë©´ reboot(ì¬ë¶€íŒ…), swapoff(ìŠ¤ì™‘ ë„ê¸°), sysctl(ì»¤ë„ íŒŒë¼ë¯¸í„° ë³€ê²½) ë“± ì¼ë°˜ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” í•„ìš” ì—†ì§€ë§Œ ê³µê²©ìì—ê²ŒëŠ” ìœ ìš©í•œ ìœ„í—˜í•œ ì‹œìŠ¤í…œ ì½œì´ ìë™ìœ¼ë¡œ ì°¨ë‹¨
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: app
          # "app:latest"ëŠ” kustomization.yamlì˜ imagesì—ì„œ ì¹˜í™˜ë¨
          # ìµœì¢…: {ECR_URL}/exchange-settlement-app:latest-dev
          image: app:latest
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 3000

          # =================================================================
          # ğŸ” í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          # AWS Secrets Manager â†’ ExternalSecret â†’ K8s Secret â†’ ì—¬ê¸°ë¡œ ì£¼ì…
          # =================================================================
          env:
            # ê¸°ë³¸ ì„¤ì •
            - name: PORT
              value: "3000"
            - name: NODE_ENV
              value: "production"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

            # -----------------------------------------------------------------
            # ğŸ“¦ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (AWS Secrets Managerì—ì„œ ì£¼ì…)
            # -----------------------------------------------------------------
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: app-secrets # K8s Secret ì´ë¦„
                  key: DB_HOST # Secret ë‚´ì˜ í‚¤
                  optional: true # ì‹œí¬ë¦¿ ì—†ì–´ë„ Pod ì‹œì‘ ê°€ëŠ¥
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DB_PORT
                  optional: true
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DB_NAME
                  optional: true
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DB_USER
                  optional: true
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DB_PASSWORD
                  optional: true

            # -----------------------------------------------------------------
            # ğŸ”‘ ì™¸ë¶€ API í‚¤ (AWS Secrets Managerì—ì„œ ì£¼ì…)
            # -----------------------------------------------------------------
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: API_KEY
                  optional: true
            - name: API_SECRET
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: API_SECRET
                  optional: true

            # -----------------------------------------------------------------
            # ğŸ” ë³´ì•ˆ í† í° (AWS Secrets Managerì—ì„œ ì£¼ì…)
            # -----------------------------------------------------------------
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: JWT_SECRET
                  optional: true
            - name: ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: ENCRYPTION_KEY
                  optional: true

          # ë¦¬ì†ŒìŠ¤ ì œí•œ
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"

          # Startup Probe (ì•± ì´ˆê¸°í™” ì‹œê°„ í™•ë³´)
          # ìµœëŒ€ ëŒ€ê¸°: 30ë²ˆ * 10ì´ˆ = 300ì´ˆ (5ë¶„)
          startupProbe:
            httpGet:
              path: /api/v1/health
              port: http
            failureThreshold: 30
            periodSeconds: 10

          # Liveness Probe (ì•±ì´ ì‚´ì•„ìˆëŠ”ì§€)
          livenessProbe:
            httpGet:
              path: /api/v1/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10

          # Readiness Probe (íŠ¸ë˜í”½ ë°›ì„ ì¤€ë¹„ ëëŠ”ì§€)
          readinessProbe:
            httpGet:
              path: /api/v1/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5

          # ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ì„¤ì •
          securityContext:
            seccompProfile:
              type: RuntimeDefault
            allowPrivilegeEscalation: false # ê¶Œí•œ ìƒìŠ¹ ê¸ˆì§€
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"] # ëª¨ë“  Linux capability ì œê±°

          # ì½ê¸° ì „ìš© íŒŒì¼ì‹œìŠ¤í…œì´ë¯€ë¡œ /tmp ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
          volumeMounts:
            - name: tmp
              mountPath: /tmp

      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi
      # Pod ì¢…ë£Œ ì‹œ 30ì´ˆ ë™ì•ˆ graceful shutdown ëŒ€ê¸°
      # - ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ì™„ë£Œ
      # - DB ì—°ê²° ì •ë¦¬
      # - ë¡œê·¸ í”ŒëŸ¬ì‹œ
      terminationGracePeriodSeconds: 30
